import { useEffect } from "react";
import { BsChevronLeft } from "react-icons/bs";
import { Link, useParams } from "react-router-dom";

import { ListStats } from "@src/components/ListStats/ListStats";
import { Loader } from "@src/components/Loader/Loader";

import { useUsersContext } from "@src/hooks/useUsersContext";
import { useModeContext } from "@src/hooks/useModeContext";

import { getTopMode } from "@src/api/get/getTopMode";
import { getMode } from "@src/api/get/getMode";

import "@src/pages/MenuModePage/MenuModePage.css";

export const MenuModePage = (): JSX.Element => {
  const { idMode } = useParams();

  const {
    topUsers,
    handleClearTopUsers,
    handleEndFetchUsers,
    handleSetErrorUsers,
    handleSetTopUsers,
    handleStartFetchUsers,
  } = useUsersContext();
  const {
    mode,
    handleClearMode,
    handleEndFetchMode,
    handleSetErrorMode,
    handleSetMode,
    handleStartFetchMode,
  } = useModeContext();

  const handleGetTopMode = async () => {
    try {
      handleStartFetchUsers();
      const response = await getTopMode(idMode!);
      handleSetTopUsers(response.data);
    } catch (error) {
      handleSetErrorUsers(String(error));
    } finally {
      handleEndFetchUsers();
    }
  };

  const handleGetMode = async () => {
    try {
      handleStartFetchMode();
      const response = await getMode(idMode!);
      handleSetMode(response.data);
    } catch (error) {
      handleSetErrorMode(String(error));
    } finally {
      handleEndFetchMode();
    }
  };

  useEffect(() => {
    handleGetTopMode();
    handleGetMode();

    return () => {
      handleClearTopUsers();
      handleClearMode();
    };
  }, []);

  if (mode.loading) {
    return (
      <main className="menu-mode-main">
        <Loader></Loader>
      </main>
    );
  }

  return (
    <main className="menu-mode-main">
      <Link to="/menu" aria-label="go home">
        <BsChevronLeft id="go-back" className="icon-go-back"></BsChevronLeft>
      </Link>

      <section className="menu-mode-page">
        <h1 className="menu-mode-page__title">{mode.mode?.name} MODE</h1>

        <article className="menu-mode-page__explication">
          <p className="menu-mode-page__description">
            {mode.mode?.description}
          </p>

          <Link
            to={`/menu/${mode.mode?._id}/start`}
            aria-label="play"
            className="menu-mode-page__play"
          >
            Â¡PLAY!
          </Link>
        </article>

        {topUsers.loading ? (
          <Loader></Loader>
        ) : (
          <ListStats
            nameTop={`${mode.mode?.name!.toUpperCase()} TOP USERS`}
            arrayTop={topUsers.users!}
          ></ListStats>
        )}
      </section>
    </main>
  );
};
